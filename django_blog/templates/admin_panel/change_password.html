{% extends 'admin_panel/base.html' %}
{% load static %}

{% block title %}Change Password - Admin Panel{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-xl-6 col-lg-8 col-md-10">
            <div class="card shadow">
                <div class="card-header bg-warning text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-key me-2"></i>
                        Password Change Required
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Security Notice:</strong> You must change your temporary password before accessing the admin panel.
                    </div>

                    <form id="password-change-form" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="current_password" class="form-label">
                                <i class="fas fa-lock me-1"></i>
                                Current Password
                            </label>
                            <input type="password" 
                                   class="form-control" 
                                   id="current_password" 
                                   name="current_password" 
                                   required>
                            <div class="invalid-feedback">
                                Please enter your current password.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="new_password" class="form-label">
                                <i class="fas fa-key me-1"></i>
                                New Password
                            </label>
                            <input type="password" 
                                   class="form-control" 
                                   id="new_password" 
                                   name="new_password" 
                                   required
                                   minlength="8">
                            <div class="form-text">
                                Password must be at least 8 characters long and contain uppercase, lowercase, number, and special character.
                            </div>
                            <div class="invalid-feedback">
                                Please enter a valid new password.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="confirm_password" class="form-label">
                                <i class="fas fa-check-circle me-1"></i>
                                Confirm New Password
                            </label>
                            <input type="password" 
                                   class="form-control" 
                                   id="confirm_password" 
                                   name="confirm_password" 
                                   required>
                            <div class="invalid-feedback">
                                Please confirm your new password.
                            </div>
                        </div>

                        <!-- Password strength indicator -->
                        <div class="mb-3">
                            <div class="password-strength">
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small class="form-text text-muted">Password strength: <span id="strength-text">Weak</span></small>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>
                                Change Password
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Password strength checker
    $('#new_password').on('input', function() {
        const password = $(this).val();
        const strength = checkPasswordStrength(password);
        updatePasswordStrength(strength);
    });

    // Password confirmation validation
    $('#confirm_password').on('input', function() {
        const password = $('#new_password').val();
        const confirm = $(this).val();
        
        if (password !== confirm) {
            $(this).addClass('is-invalid');
            $(this).siblings('.invalid-feedback').text('Passwords do not match.');
        } else {
            $(this).removeClass('is-invalid').addClass('is-valid');
        }
    });

    // Form submission
    $('#password-change-form').on('submit', function(e) {
        e.preventDefault();
        
        const formData = $(this).serialize();
        const submitBtn = $(this).find('button[type="submit"]');
        
        // Validate passwords match
        const newPassword = $('#new_password').val();
        const confirmPassword = $('#confirm_password').val();
        
        if (newPassword !== confirmPassword) {
            showNotification('Passwords do not match', 'error');
            return;
        }
        
        submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Changing Password...');
        
        $.ajax({
            url: '/admin-panel/change-password/',
            method: 'POST',
            data: formData,
            success: function(response) {
                if (response.success) {
                    showNotification('Password changed successfully! Redirecting...', 'success');
                    setTimeout(() => {
                        window.location.href = '/admin-panel/dashboard/';
                    }, 2000);
                } else {
                    showNotification(response.message, 'error');
                }
            },
            error: function() {
                showNotification('An error occurred. Please try again.', 'error');
            },
            complete: function() {
                submitBtn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Change Password');
            }
        });
    });

    function checkPasswordStrength(password) {
        let score = 0;
        
        if (password.length >= 8) score++;
        if (/[a-z]/.test(password)) score++;
        if (/[A-Z]/.test(password)) score++;
        if (/[0-9]/.test(password)) score++;
        if (/[^A-Za-z0-9]/.test(password)) score++;
        
        return score;
    }

    function updatePasswordStrength(score) {
        const progressBar = $('.progress-bar');
        const strengthText = $('#strength-text');
        
        let width, color, text;
        
        switch (score) {
            case 0:
            case 1:
                width = '20%';
                color = 'bg-danger';
                text = 'Very Weak';
                break;
            case 2:
                width = '40%';
                color = 'bg-warning';
                text = 'Weak';
                break;
            case 3:
                width = '60%';
                color = 'bg-info';
                text = 'Fair';
                break;
            case 4:
                width = '80%';
                color = 'bg-primary';
                text = 'Good';
                break;
            case 5:
                width = '100%';
                color = 'bg-success';
                text = 'Strong';
                break;
        }
        
        progressBar.css('width', width).removeClass().addClass('progress-bar ' + color);
        strengthText.text(text);
    }
});
</script>
{% endblock %}